# Bitrix-img2picture-module


Модуль для оптимизации изображений на сайте.

В результате в зависимости от разрешения экрана и возможностей браузера будет загружаться соответствующая картинка.

Есть возможность настроить, чтобы для мобилных устройств загружалось уменьшенное изображение, а для десктопных полноразмерная, что экономиит трафик. (все это настраивается)

И если браузер умеет (а сейчас почти все умеют) показывать webp, по будет загружено изображение в формате webp.

Несколько режимов работы модуля:

- Выключен - когда разработчик сам управляет и просто использует где ему необходимо функции модуля,
- Тестирование - собственно для тестирования работы модуля и отладки шаблона замены
- Включен - модуль ищет и заменяет теги img в соответсвии с настройками модуля.

# Как это работает


Модуль заменяет теги img на теги picture с ресайзом и конвертацией изображений.

Модуль так-же заменяет background с ресайзом и конвертацией изображений.

Модуль не работает если текущий пользователь адмиристратор - для того чтобы не заменять теги во время редактирования контента.

Модуль не работает в администаривной части сайта.

Т.е. тестирование работы модуля надо проводить НЕ авторизованным пользователем в режиме "тестирование".


# В режиме "Тестирование":


включить модуль дописав get параметр ?img2picture=on

выключить модуль дописав get параметр ?img2picture=off

лог пишется в стандартный файл битрикса (по умолчанию /__bx_log.log)

------
# После установки модуля доступны следующие функции:

	IS_PRO\img2picture::doIt(string $content, array $option = [])

вернет контент с замененными img на picture

$content - контент в котором необходимо заменить все img

$option - необязательный массив параметров замены

---

	IS_PRO\img2picture::MakeWebp(string $src, array $option = [])
	IS_PRO\img2picture::MakeAvif(string $src, array $option = [])

вернет ссылку на созданный webp/avif соответвенно

в случае не удачи вернет false

$src - ссылка на изображение

$option - необязательный массив
параметров замены

---

	IS_PRO\img2picture::GetOptions()

вернет параметры модуля

# Доступные события модуля:
Можно перехватить и кастомизировать замену

	/* Для перехвата замены img */
	$eventManager = \Bitrix\Main\EventManager::getInstance();
	$eventManager->addEventHandler("is_pro.img2picture", "OnPrepareResultImg", "MyPicture");

	function MyPicture(\Bitrix\Main\Event $event)
	{
		$arParam = $event->getParameters();
		$arResult = &$arParam[0];
		/* Какой-то код меняющий $arResult */
		/* $arResult["place"] - содержит результирующий тег */
	}

	/* Для перехвата замены backgropunds */
	$eventManager = \Bitrix\Main\EventManager::getInstance();
	$eventManager->addEventHandler("is_pro.img2picture", "OnPrepareResultBackground", "MyBackground");

	function MyBackground(\Bitrix\Main\Event $event)
	{
		$arParam = $event->getParameters();
		$arResult = &$arParam[0];
		/* Какой-то код меняющий $arResult */
		/* $arResult["place"] - содержит результирующий тег */
	}


# Управление модулем на странице

Иногда надо обновить кеш только на конкретной странице или посмотреть почему что-то неправильно конвертируется

Вы должны быть НЕ авторизованы

включить отладку на странице ?img2pictureDebug=Y

отчистить кеш и переконвертировать изображений на странице ?img2pictureClearCache=Y

отчистить кеш и переконвертировать отдельного изображения на странице ?img2pictureClearCache=[SRC картинки]
